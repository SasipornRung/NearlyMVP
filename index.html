<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PropDecoded • PoC</title>

  <!-- Leaflet (แผนที่) -->
  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Chart.js (ใช้วาดพอร์ตนักลงทุน) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --green:#2E7D5B; --green-100:#E9F6F0; --green-300:#BFE3D2;
      --teal:#1F6F63; --yellow:#F5E29E; --ink:#12333A; --muted:#6A7D80;
      --card:#ffffff; --shadow:0 8px 24px rgba(0,0,0,.08); --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Prompt",Arial,sans-serif;
      background:linear-gradient(180deg,var(--green-100),#F7FAF9);
      color:var(--ink)
    }
    .container{max-width:1120px;margin:0 auto;padding:16px 20px 80px}
    .header{display:flex;align-items:center;gap:12px;padding:6px 0 10px;font-weight:800}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--teal));display:grid;place-items:center;color:#fff;box-shadow:var(--shadow)}
    h1{margin:8px 0 12px}

    /* เมนูด่วน */
    .quick-grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
    @media(min-width:900px){.quick-grid{grid-template-columns:repeat(4,1fr)}}
    .qcard{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:18px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;border:none}
    .qicon{width:36px;height:36px;border-radius:10px;background:var(--green-300);display:grid;place-items:center;font-weight:900;color:var(--teal)}
    .qtitle{font-weight:800}
    .hint{color:var(--muted);font-size:13px;margin-top:2px}

    /* เลนส์ */
    .lens-bar{margin:18px 0 12px;display:flex;gap:8px;flex-wrap:wrap}
    .seg{border:2px solid var(--green);border-radius:999px;padding:4px;display:inline-flex;gap:6px;background:#fff;box-shadow:var(--shadow)}
    .seg button{all:unset;padding:8px 14px;border-radius:999px;color:var(--green);font-weight:700;cursor:pointer}
    .seg button.active{background:linear-gradient(180deg,var(--green-300),#fff);color:var(--ink);box-shadow:inset 0 0 0 2px rgba(255,255,255,.6)}

    /* เนื้อหา 2 คอลัมน์ */
    .main{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:start}
    @media(max-width:920px){.main{grid-template-columns:1fr}}

    /* แผนที่ */
    #map{height:56vh;min-height:320px;border-radius:16px;box-shadow:var(--shadow);}

    /* การ์ด insight */
    .insight{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px 16px 10px}
    .badge{display:inline-block;background:var(--green-300);color:var(--teal);padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;margin-right:6px}
    .meter{height:10px;background:#ECF2F3;border-radius:999px;overflow:hidden}
    .meter>span{display:block;height:100%;background:linear-gradient(90deg,#CFEBDD,var(--yellow));width:40%}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0}
    .kpi .card{background:#fff;border:1.5px solid #E5EFE9;border-radius:14px;padding:12px}
    .kpi h4{margin:0 0 6px}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--green);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
    details{background:#FAFCFB;border:1.5px solid #E5EFE9;border-radius:12px;padding:10px 12px;margin:6px 0}
    summary{cursor:pointer;font-weight:700}

    /* === Range bar (สำหรับเลนส์ Developer) === */
    .rent-range-wrap{font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Prompt",sans-serif; margin:10px 0}
    .rent-range-title{margin-bottom:6px; color:#12333A; font-weight:700}
    .rent-range-bar{
      position:relative; height:28px; border-radius:14px; overflow:hidden;
      background:linear-gradient(90deg,#2E7D5B 0%, #F5E29E 50%, #d44a54 100%);
      box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .rent-range-frame{position:absolute; inset:0; border:2px solid #fff; border-radius:14px; pointer-events:none}
    .rent-range-labels{display:flex; justify-content:space-between; color:#6A7D80; font-size:12px; margin-top:4px}
    .rent-range-marker{
      position:absolute; top:50%; transform:translate(-50%,-50%);
      width:12px; height:12px; border-radius:50%; background:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.15);
    }
    .rent-range-tag{
      position:absolute; transform:translate(-50%,8px);
      background:#eef2ff; color:#1e40af; font-size:12px; padding:3px 8px; border-radius:999px; white-space:nowrap
    }
    .rent-range-note{font-size:12px; color:#6A7D80; margin-top:4px)

    /* layout ของส่วนพอร์ตนักลงทุน */
    .inv-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">PD</div> PropDecoded
    </header>

    <h1>ยินดีต้อนรับ</h1>

    <!-- เมนูด่วน -->
    <section class="quick-grid" aria-label="เมนูด่วน">
      <button class="qcard" data-action="get-started">
        <div class="qicon">➤</div>
        <div><div class="qtitle">เริ่มต้นใช้งาน</div><div class="hint">เลือกเลนส์แล้วเริ่มสำรวจ</div></div>
      </button>
      <button class="qcard" data-action="insights">
        <div class="qicon">⌁</div>
        <div><div class="qtitle">บทวิเคราะห์</div><div class="hint">อ่าน insight ที่คัดสรร</div></div>
      </button>
      <button class="qcard" data-action="legal">
        <div class="qicon">§</div>
        <div><div class="qtitle">ข้อกฎหมายที่ควรทราบ</div><div class="hint">ข้อมูลกลางเพื่อประกอบความเข้าใจ</div></div>
      </button>
      <button class="qcard" data-action="contact">
        <div class="qicon">☎</div>
        <div><div class="qtitle">ติดต่อเรา</div><div class="hint">อีเมลถึงทีมงาน</div></div>
      </button>
    </section>

    <!-- สวิทช์ 3 เลนส์ -->
    <section class="lens-bar">
      <div class="seg" role="tablist" aria-label="มุมมองข้อมูล">
        <button class="active" id="lens-tenant"   role="tab" aria-selected="true">ผู้เช่า</button>
        <button id="lens-investor"  role="tab" aria-selected="false">นักลงทุน</button>
        <button id="lens-renovator" role="tab" aria-selected="false">รีโนเวท/ดีเวลอป</button>
      </div>
    </section>

    <!-- เนื้อหาหลัก -->
    <section class="main">
      <div id="map" aria-label="แผนที่"></div>

      <aside class="insight">
        <span class="badge" id="lensTag">ผู้เช่า</span>
        <h3 id="areaTitle">วัฒนา</h3>
        <div class="muted" id="subtitle">ภาพรวมสำหรับผู้อยู่อาศัย</div>

        <div style="margin:12px 0 6px;font-weight:800">ตัวชี้วัดหลัก</div>
        <div class="meter"><span id="meterFill" style="width:60%"></span></div>

        <div class="kpi">
          <div class="card"><h4>ข้อมูลย่อ</h4><div class="muted" id="kpiLeftDesc">CBD ~ 18 นาที • BTS ~ 6 นาที</div></div>
          <div class="card"><h4 id="kpiRightTitle">รีวิวล่าสุด</h4><div class="muted" id="kpiRightDesc">“ย่านเงียบช่วงกลางคืน มีร้านสะดวกซื้อใกล้ ๆ”</div></div>
        </div>

        <details open><summary>รายละเอียด</summary>
          <p class="muted" id="detailsText">• ตัวอย่างข้อความรายละเอียดจากไฟล์ JSON</p>
        </details>

        <!-- === Developer Benchmarks (เฉพาะเลนส์รีโนเวท/ดีเวลอป) === -->
        <section id="devBench" hidden style="margin-top:10px">
          <div class="badge">Developer Benchmarks</div>
          <div id="devMarketMount"></div>
          <div id="devOwnerMount" style="margin-top:12px"></div>
        </section>

        <!-- === Investor Portfolio (เฉพาะเลนส์นักลงทุน) === -->
        <section id="investorViz" hidden style="margin-top:12px">
          <div class="badge">Investor Portfolio</div>
          <div class="inv-grid">
            <canvas id="profitPie" height="180"></canvas>
            <div class="card" style="border:1.5px solid #E5EFE9;border-radius:14px;padding:12px">
              <h4 style="margin:0 0 6px">Summary</h4>
              <div class="muted" id="sumRooms">Invested Rooms: –</div>
              <div class="muted" id="sumAvgRoi">Average ROI: –</div>
              <div class="muted" id="sumProfit">Total Profit: –</div>
            </div>
          </div>
          <div class="muted" id="lossNote" style="margin-top:6px;display:none">
            * หมายเหตุ: ห้องที่ขาดทุนจะแสดงสัดส่วนเป็นศูนย์ในกราฟ และถูกคิดรวมในกำไรสุทธิ
          </div>
        </section>

        <button class="btn" id="seeMore">ดูรายละเอียดเชิงลึก</button>
      </aside>
    </section>
  </div>

  <script>
  // รันหลังหน้าโหลดเสร็จ (ให้แน่ใจว่า Leaflet/Chart.js พร้อม)
  window.addEventListener('load', () => {

    /* ---------- Map ---------- */
    const map = L.map('map').setView([13.736717, 100.523186], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    [[13.7307,100.5402,'Condo A'], [13.7425,100.5167,'Condo B'], [13.7253,100.5101,'Condo C']]
      .forEach(([lat,lng,label]) => L.marker([lat,lng]).addTo(map).bindPopup(label));

    /* ---------- Load JSON (กันแคช + ชี้ไป root เดียวกัน) ---------- */
    async function loadLens(lens){
      const url = `./${lens}.json?v=${Date.now()}`;
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error('load json error: '+lens);
      return res.json();
    }

    /* ---------- Elements ---------- */
   const lensBtns = {
      tenant:   document.getElementById('lens-tenant'),
      investor: document.getElementById('lens-investor'),
      renovator:document.getElementById('lens-renovator')
    };
    const lensTag       = document.getElementById('lensTag');
    const subtitle      = document.getElementById('subtitle');
    const meterFill     = document.getElementById('meterFill');
    const kpiLeftDesc   = document.getElementById('kpiLeftDesc');
    const kpiRightTitle = document.getElementById('kpiRightTitle');
    const kpiRightDesc  = document.getElementById('kpiRightDesc');
    const detailsText   = document.getElementById('detailsText');

    /* ---------- Renderer: Range bar (Developer) ---------- */
    function fmt(n){return Number(n).toLocaleString('th-TH',{maximumFractionDigits:0})}
    function clamp(x,a,b){return Math.max(a, Math.min(b, x))}
    function renderRentRange(mount, data){
      mount.innerHTML = '';
      if(!data || !(data.min>0) || !(data.max>data.min)) return;

      const elMin = Number(data.min), elMax = Number(data.max);
      const elAct = clamp(Number(data.actual ?? elMin), elMin, elMax);
      const title = data.title || 'ช่วงราคา', unit = data.unit || 'บาท/เดือน';

      const wrap = document.createElement('div'); wrap.className='rent-range-wrap';
      const h = document.createElement('div'); h.className='rent-range-title'; h.textContent = title;
      const bar = document.createElement('div'); bar.className='rent-range-bar';
      const frame = document.createElement('div'); frame.className='rent-range-frame';
      const marker = document.createElement('div'); marker.className='rent-range-marker';
      const tag = document.createElement('div'); tag.className='rent-range-tag'; tag.textContent = `ราคาของคุณ: ${fmt(elAct)} ${unit}`;
      const labels = document.createElement('div'); labels.className='rent-range-labels';
      labels.innerHTML = `<span>${fmt(elMin)}</span><span>${fmt(elMax)}</span>`;
      const note = document.createElement('div'); note.className='rent-range-note';

      bar.appendChild(frame); bar.appendChild(marker); bar.appendChild(tag);
      wrap.appendChild(h); wrap.appendChild(bar); wrap.appendChild(labels); wrap.appendChild(note);
      mount.appendChild(wrap);

      const position = ()=>{
        const rect = bar.getBoundingClientRect();
        const p = (elAct - elMin) / (elMax - elMin);
        const x = p * rect.width;
        marker.style.left = x + 'px';
        tag.style.left = x + 'px';
        const mid = (elMin + elMax)/2, diffPct = ((elAct - mid)/mid)*100;
        const zone = (p<.33)?'ช่วงล่าง':(p>.67?'ช่วงบน':'กลางช่วง');
        note.innerHTML = `ตำแหน่ง: <b>${zone}</b> (ต่างจากค่ากลาง ~${diffPct.toFixed(1)}%)`;
      };
      position(); window.addEventListener('resize', position);
    }

    /* ---------- Investor pie chart ---------- */
    let profitChart = null;
    function pct(n){ return (Number(n||0)*100).toFixed(1)+'%'; }
    function renderInvestorViz(data){
      const wrap = document.getElementById('investorViz');
      const ctx  = document.getElementById('profitPie').getContext('2d');
      const elRooms = document.getElementById('sumRooms');
      const elAvg   = document.getElementById('sumAvgRoi');
      const elProf  = document.getElementById('sumProfit');
      const lossNote = document.getElementById('lossNote');

      const items = Array.isArray(data?.investments) ? data.investments : [];
      const labels = items.map(x=>x.label || 'Room');
      const profits = items.map(x=>Number(x.profit||0));
      const invested = items.map(x=>Number(x.invested||0));
      const rois = items.map((x,i)=>{
        if (typeof x.roi === 'number') return x.roi;
        return invested[i] > 0 ? profits[i]/invested[i] : 0;
      });

      const hasLoss = profits.some(p => p < 0);
      const pieData = profits.map(p => Math.max(p, 0)); // pie ไม่รับค่าติดลบ

      const totalProfit = profits.reduce((a,b)=>a+b,0);
      const totalInvest = invested.reduce((a,b)=>a+b,0);
      const avgROI = totalInvest>0
        ? (profits.reduce((a,b,i)=>a + (invested[i]||0)*rois[i],0) / totalInvest)
        : (rois.length ? rois.reduce((a,b)=>a+b,0)/rois.length : 0);

      elRooms.textContent = `Invested Rooms: ${items.length}`;
      elAvg.textContent   = `Average ROI: ${pct(avgROI)}`;
      elProf.textContent  = `Total Profit: ${fmt(totalProfit)} THB`;
      lossNote.style.display = hasLoss ? 'block' : 'none';

      if (profitChart) profitChart.destroy();
      profitChart = new Chart(ctx, {
        type: 'pie',
        data: { labels, datasets: [{ data: pieData }] },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (tt) => {
                  const p = profits[tt.dataIndex];
                  const sign = p<0 ? '−' : '';
                  const val = Math.abs(p);
                  return `${tt.label}: ${sign}${fmt(val)} THB`;
                }
              }
            }
          }
        }
      });

      wrap.hidden = false;
    }

    /* ---------- Apply lens ---------- */
    async function applyLens(lens){
      localStorage.setItem('pd_lens', lens);
      Object.entries(lensBtns).forEach(([id,btn])=>{
        btn.classList.toggle('active', id===lens);
        btn.setAttribute('aria-selected', id===lens ? 'true' : 'false');
      });

      // สถานะโหลด
      subtitle.textContent = 'กำลังโหลด…';
      meterFill.style.width = '0%';

      try{
        const c = await loadLens(lens);
        lensTag.textContent = c.tag || '';
        subtitle.textContent = c.subtitle || '';
        meterFill.style.width = Math.round((c.meter||0)*100) + '%';
        kpiLeftDesc.textContent = c.kpiLeftDesc || '';
        kpiRightTitle.textContent = c.kpiRightTitle || '';
        kpiRightDesc.textContent = c.kpiRightDesc || '';
        detailsText.innerHTML = c.detailsText || '';

        // Developer: เรนเดอร์แถบช่วง
        const devBlock = document.getElementById('devBench');
        const marketMount = document.getElementById('devMarketMount');
        const ownerMount  = document.getElementById('devOwnerMount');
        if (lens === 'renovator') {
          devBlock.hidden = false;
          marketMount.innerHTML = ''; ownerMount.innerHTML = '';
          if (c.devMarket) renderRentRange(marketMount, {
            title:'ช่วงราคาตลาด (ยูนิตใกล้เคียง)', unit:c.devMarket.unit,
            min:c.devMarket.min, max:c.devMarket.max, actual:c.devMarket.actual
          });
          if (c.devOwner) renderRentRange(ownerMount, {
            title:'ช่วงแนะนำ (Developer)', unit:c.devOwner.unit,
            min:c.devOwner.min, max:c.devOwner.max, actual:c.devOwner.actual
          });
        } else {
          devBlock.hidden = true;
        }

        // Investor: วาด Pie + Summary
        const investorViz = document.getElementById('investorViz');
        if (lens === 'investor') {
          investorViz.hidden = true;
          renderInvestorViz(c);
        } else {
          investorViz.hidden = true;
        }

      }catch(e){
        console.error(e);
        subtitle.textContent = 'โหลดไม่สำเร็จ';
      }
    }

    // ปุ่มเลนส์
    lensBtns.tenant  .addEventListener('click', ()=>applyLens('tenant'));
    lensBtns.investor.addEventListener('click', ()=>applyLens('investor'));
    lensBtns.renovator.addEventListener('click', ()=>applyLens('renovator'));

    // เมนูด่วน
    const lensBar = document.querySelector('.lens-bar');
    document.querySelector('[data-action="get-started"]')
      ?.addEventListener('click', ()=> lensBar?.scrollIntoView({behavior:'smooth', block:'center'}));
    document.querySelector('[data-action="insights"]')
      ?.addEventListener('click', ()=> alert('พื้นที่ “บทวิเคราะห์” (placeholder)'));
    document.querySelector('[data-action="legal"]')
      ?.addEventListener('click', ()=> alert('พื้นที่ “ข้อกฎหมายที่ควรทราบ” (placeholder)'));
    document.querySelector('[data-action="contact"]')
      ?.addEventListener('click', ()=> window.open('mailto:hello@propdecoded.example','_blank'));

    // เริ่มด้วยเลนส์เดิม (หรือผู้เช่า)
    applyLens(localStorage.getItem('pd_lens') || 'tenant');
    });
  </script>
</body>
</html>
